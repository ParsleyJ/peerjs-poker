<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>
    <script src="scripts/require.js"></script>
    <script>
        $(document).ready(()=> {
            require(["./scripts/remotePlayer"], (remotePlayer) => {

                function askQuestion(query) {
                    console.log("[ASKED VIA PROMPT]: '" + query + "'");
                    return new Promise(resolve => {
                        resolve(prompt(query, ""))
                    });
                }

                class PlayerClient {
                    _peer;
                    _connection;
                    _messageQueue = new remotePlayer.MessageQueue();
                    _playerName;
                    _initialBudget;

                    constructor(clientID, playerName, initialBudget) {
                        this._playerName = playerName;
                        this._initialBudget = initialBudget;
                        this._peer = new Peer(clientID, {
                            host: 'localhost',
                            port: 9000,
                            path: '/pokerGame'
                        });
                    }

                    register(to) {
                        console.log("registering to " + to + " ...");
                        this._connection = this._peer.connect(to);
                        this._connection.serialization = 'json';
                        this._connection.on("open", () => {
                            console.log("connection open with " + to);
                            this._connection.send(
                                new remotePlayer.ClientRequestMessage("register", [this._playerName, this._initialBudget])
                            );
                        })

                        this._peer.on("connection", conn => {
                            console.log("a peer connected: " + conn.peer);
                            conn.serialization = 'json';
                            conn.on("data", data => {
                                console.log("data received: " + data);
                                if (data instanceof remotePlayer.Message) {
                                    console.log("enqueueing the message.")
                                    this._messageQueue.enqueue(data);
                                }
                            });

                            conn.on("open", async () => {
                                for await (const message of this.extractMessages()) {
                                    await this.handleMessage(message);
                                }
                            })
                        })


                        this._connection.on("data", data => {
                            if (data instanceof remotePlayer.Message) {
                                this._messageQueue.enqueue(data);
                            }
                        })
                        this._connection.on("open", async () => {
                            for await (const message of this.extractMessages()) {
                                await this.handleMessage(message);
                            }
                        })
                    }

                    async* extractMessages() {
                        while (true) {
                            yield await this._messageQueue.dequeue();
                        }
                    }

                    async handleMessage(message) {
                        console.log("Received message from remote interface: " + message);
                        switch (message[0]) {
                            case "event": {
                                await askQuestion("Notification: " + message[1] + " (press enter to continue)");
                            }
                                break;
                        }
                    }
                }



                let pl = new PlayerClient("ciccio", "ciccioRemoto", 30_000);
                console.log("registering ...");
                setTimeout((()=>pl.register("room0")), 1500);



            });
        });
    </script>
    <title>Client</title>
</head>
<body>

</body>
</html>